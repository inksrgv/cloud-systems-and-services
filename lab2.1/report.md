# Лабораторная работа №2

## Задание
1. Написать “плохой” Dockerfile, в котором есть не менее трех “bad practices” по написанию докерфайлов
2. Написать “хороший” Dockerfile, в котором эти плохие практики исправлены
3. В Readme описать каждую из плохих практик в плохом докерфайле, почему она плохая и как в хорошем она была исправлена, как исправление повлияло на результат
4. В Readme описать 2 плохих практики по работе с контейнерами. ! Не по написанию докерфайлов, а о том, как даже используя хороший докерфайл можно накосячить именно в работе с контейнерами.

## Ход выполнения работы

### "Плохой" Dockerfile

Плохой Dockerfile будет выглядеть так:

    FROM python:3.10-alpine
  
    RUN apk update
    RUN apk upgrade

    COPY requirements.txt .

    RUN pip install -r requirements.txt

    COPY . .

    EXPOSE 5000

    CMD [ "python","app.py" ]

Теперь перейдем к описанию "плохих практик", которые есть в данном Dockerfile:
1. Каждая команда, которую нам надо выполнить (в данном случае команды update & upgrade) записаны в отдельную инструкцию `RUN`. Это плохо, потому что каждая такая инструкция создаст новый слой в контейнере, таким образом увеличив его размер. На самом деле, в моем случае это не так уж и сильно усугубляет положение, однако при большем наборе инструкций RUN это может конкретно увеличить размер контейнера и снизить производительность.
2. Не указана рабочая директория с помощью инструкции `WORKDIR`, что может повлечь за собой непредсказуемое выполнение последующих команд. 
3. Из-за строчки `COPY . .` внутрь контейнера копируется все содержимое локальной директории, что может значительно увеличить размеры Dockerfile. Вообще эту инструкцию лучше так не писать, но можно обойти это правило путём создания файла `.dockerignore`, ну или же указанием только необходимых для копирования файлов.
4. Нет чистки от дополнительных зависимостей, которые появляются при установке библиотек или обновлении пакетов. Это может увеличить размер Dockerfile, тк некторые зависимости подтягивают очень много кэша, который хранить необязательно.

<details>
  <summary> Какие еще есть плохие практики </summary>

  1. Не указывать явно версию образа, которую хочешь установить. Как это выглядит в коде:

    FROM python:latest

  Данная строчка в принципе непредсказуема, тк непонятно, какая именно версия будет установлена. Также при использовании именно такого определения образа могут возникнуть проблемы с совместимостью версий, что тоже не совсем ок.
  
  2. Явное указание перемнных окружения, например для баз данных. Во-первых, данные, хранящиеся таким способом легко потерять. Во-вторых, это небезопасно, тк нередко в перменных окружения хранятся ключи доступа, пароль и т.д.
  3. Установка пакетов, которые на данный момент не нужны, однако когда-то там зачем-то там могут понадобиться. Такая практика не редкость, однако она является нежелательной и увеличивает размер файлов и время сборки, что не очень круто :(

</details>

Несмотря на все "плохие практики" представленный Dockerfile является рабочим. Соберем наш контейнер:

![photo_2024-10-14_12-40-30](https://github.com/user-attachments/assets/128f5b8b-f062-4787-b4a9-376c3f0d135b)

А теперь запустим его: 

![photo_2024-10-14_11-56-45](https://github.com/user-attachments/assets/64c0eaec-c86d-4099-b092-8091de9588b9)

Работает :)

### "Хороший" Dockerfile 

Теперь перейдем к исправлению "плохих" практик. Хороший Dockerfile будет выглядеть так:

    FROM python:3.10-alpine

    RUN apk update && apk upgrade && apk add --no-cache bash
    
    WORKDIR /home/test

    COPY requirements.txt .

    RUN pip install --no-cache-dir -r requirements.txt

    COPY . .

    EXPOSE 5000

    CMD [ "python","app.py" ]

Что изменилось:
1. Теперь в файле есть только одна инструкция `RUN`, что уменьшило количество создаваемых слоёв.
2. Добавлена инструкция `WORKDIR`, которая указывает на рабочую директорию проекта. Теперь выполнение всех последующих команд будет более предсказуемым.
3. Создан файл `.dockerignore`, в котором были указаны нежелательные для копирования файлы (в этом проекте это "плохой" докерфайл, однако в более больших проектах с кучей файлов в файле `.dockerignore` может быть указано куча директорий и файлов)
4. С помощью флага `--no-cache-dir` загруженные с pip install пакеты не кэшируются, что уменьшает размер итогового образа.

<details>
<summary> Еще немного хороших практик </summary>
    
1. Использование [multi-stage builds](https://docs.docker.com/build/building/multi-stage/). С помощью многоступенчатой сборки можно очень сильно сократить размер итогового контейнера. В моем контейнере она правда не нужна, но для больших контейнеров это отличная практика.
2. Прописывать переменные окружения в файлах `.env`. Так безопаснее и вообще лучше :)

</details>

Соберём теперь хороший Dockerfile:

![photo_2024-10-14_12-10-48](https://github.com/user-attachments/assets/5ecd1dc2-a0c5-4483-8969-1f987f925dee)

Как можно заметить, время сборки сократилось. Теперь запустим контейнер: 

![photo_2024-10-14_12-12-50](https://github.com/user-attachments/assets/dec69d77-43f5-4ba3-b993-b3b30a5f8bfe)

Победа!

### Плохие практики по работе с контейнерами

1. Хранить важные данные внутри контейнера. С контейнером может произойти все что угодно (например, его могут удалить), поэтому хранение важных данных внутри него - это опасно. Лучше хранить их где-нибудь вне)
2. Недостаточная изоляция данных (например, когда несколько контейнеров имеют доступ к БД без ограничений) может привести к утечке данных. 
